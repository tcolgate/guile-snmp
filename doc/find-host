#!/usr/local/bin/snmp-report -s
!#
;;-------------------------------------------------------------------
;; Copyright (C) 2009 Tristan Colgate 
;;
;; goal.scm - This is intended to be a complex example of the ideal
;; grammar intended for reporting.
;;
;;-------------------------------------------------------------------

;This is done purely to help us find our own module for purposes of (help)
(set! %load-path (cons "/usr/local/bin" %load-path))

;;; Commentary:
;;
;;  Useage: find-host [OPTIONS] host1 host2 ...
;;   This command locates the Layer 2 connection for a given hostname
;;  using a hard coded list of Layer 3 devices as the intial point of
;;  the query.
;;
;;; Code:

; This is a list of all the layer3 routers to query
(define l3list (list 
                 "192.168.0.254" "192.168.0.254"))

(define (find-host name)
  "find-host: Track a host to the layer2 switch and port it is connected to"
  (let* ((router (one-of l3list))
         (hostipstr (inet-ntoa (car(vector-ref (gethostbyname name) 4))))
         (hostipoid (list->u32vector (map string->number (string-split hostipstr  #\. )))))
    (session #:host router 
      (let* ((arp (walk-on-fail ipNetToMediaPhysAddress))
             (ip (% 2 5 (iid arp)))
             (mac (arp)))
        (if (not (equal? hostipoid ip))
          ((fail))
          (let* ((vlan (walk-on-fail vtpVlanState))
                 (vlanid (% 2 (iid vlan)))
                 (vlancomm (string-append (currnet-community) (string-append "@" (number->string vlanid)))))
            (session #:community vlancomm
              (let* ((mapint      (get-or-fail (+ dot1dTpFdbPor (mac-as-oid mac))))
                     (validmapint (if (unspecified? (mapint))
                                    ((fail))
                                    (mapint)))
                     (intif       (get-or-fail (+ dot1dBasePortIfIndex validmapint)))
                     (intifDescr  (value (get-or-fail (+ ifDescr (intif)))))
                     (poports     (walk-on-fail pagpGroupIfIndex)))
                 (if (not (equal? (poports) (intif)))
                   ((fail))
                   (let* ((neighbour (walk-on-fail (+ cdpCacheAddress (iid poports))))
                          (neighbourstr (ipstr-to-str (neighbour))))
                     (if (find-if (lambda(item)(equal? item neighbourstr)) l3list)
                       ((fail)) ; The neighbour is in the l3 list so we will check it anyway
                       (session #:host neighbourstr 
                         (let* ((peername (get-or-fail sysName.0))
                                (fdbport  (get-or-fail (+ dot1dTpFdbPort (mac-as-oid mac))))
                                (fdbif    (get-or-fail (+ dot1dBasePortIfIndex (fdbport))))
                                (port     (get-or-fail (+ ifDescr (fdbif))))
                                (podesc   (get-or-fail (+ ifAlias (fdbif)))))
                           (format #t "Host: ~a  ~% Via Router: ~A ~% VLAN: ~A ~% Neighbour: ~A ~% Name: ~A ~% Port: ~A ~% Desc: ~A ~%"  name router vlanid  neighbourstr (peername)(port)(podesc)))))))))))))))

(find-host (car (script-arguments)))

; vim: ft=scheme:lisp:autoindent
